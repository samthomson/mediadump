function getTree(){$.get("/api/tree",function(e){oTree=e,renderTree()})}function cancelSearch(){xhrSearch&&4!=xhrSearch.readystate&&xhrSearch.abort(),setLoading(!1)}function performSearch(e){if("undefined"==typeof e&&closeLightbox(),oaQueries.length>0){setLoading(!0),xhrSearch&&4!=xhrSearch.readystate&&cancelSearch();var t="";oaQueries.forEach(function(e,o){t+=e.value,o!=oaQueries.length-1&&(t+="|")});var o=new Date;xhrSearch=$.get("/api/search",{query:decodeURIComponent(t),page:iPage},function(t){var a=new Date,i=new Date;i.setTime(a.getTime()-o.getTime()),iSearchSpeed=i.getMilliseconds(),oResults=t.results,oResultsData=t.info,setLoading(!1),renderResults(),renderPagination(),"undefined"!=typeof e&&(e=parseInt(e),e>-1&&thumbClick(e))})}}function folderFromUniqueDir(e){var t=e.split("/"),o=t.length-1;0>o&&(o=0),e=t.length>0?t[o]:"",t=e.split("\\");var o=t.length-1;return 0>o&&(o=0),t.length>0?t[o]:""}function urlFromHash(e,t){switch(e){case"lightbox":return sCdnURL+"/thumbs/large/"+t+".jpg";case"icon":return sCdnURL+"/thumbs/icon/"+t+".jpg";case"medium":return sCdnURL+"/thumbs/medium/"+t+".jpg";case"small":return sCdnURL+"/thumbs/small/"+t+".jpg"}}function sFilterQuery(e){return e.toLowerCase()}function _buildUrlFromParams(){var e={};oaQueries.length>0&&(e.queries=encodeURIComponent(JSON.stringify(oaQueries))),"browse"!=sSearchMode&&(e.mode=encodeURIComponent(sSearchMode)),iPage>1&&(e.page=encodeURIComponent(iPage)),iFile>-1&&(e.file=encodeURIComponent(iFile)),window.location.hash=$.param(e)}function sReplaceQuote(e){return e.replace(/'/g,"\\'")}function renderTree(){var e="";oTree.forEach(function(t){var o="",a=sLinkSafeJSString(t.value),i=sReplaceQuote(folderFromUniqueDir(t.value)),s=folderFromUniqueDir(t.value),n=sGenerateLinkHref(t.display,t.value);a=sReplaceQuote(t.value),o+='<a class="tree_link col-xs-6 col-sm-4 col-md-3 col-lg-2" onclick="setSolitaryQuery(\''+i+"', '"+a+'\'); return false;" alt="'+i+'" title="'+i+'" href="'+n+'">',o+='<div class="tree_image_container">',o+='<img class="lazy" data-original="'+urlFromHash("medium",t.hash,"")+'"/>',o+="</div>",o+='<span class="tree_link_title">'+s+"</span>",o+="</a>",e+=o}),$("#browse_tree").html(e),$("#browse_tree img.lazy").lazyload({container:$("#results"),effect:"fadeIn",placeholder:"data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACwAAAAAAQABAAACAkQBADs=",threshold:300})}function sGenerateLinkHref(e,t){var t=sLinkSafeJSString(t),o=(sReplaceQuote(folderFromUniqueDir(t)),folderFromUniqueDir(t)),a=[],i={};i.display=o,i.value=t,a.push(i),t=sReplaceQuote(sLinkSafeJSString(t));var s={};return s.queries=encodeURIComponent(JSON.stringify(a)),window.location.hash+"#"+$.param(s)}function renderResults(){var e="",t="",o=$("#thumb_results").innerWidth()-20,a=0,i=r,s=0,n=0,r=300,l=4;for(i=r;oaMarkers.length>0;)oaMarkers.pop().setMap(null);oaMarkers.length=0,"undefined"!=typeof oResults?oResults.forEach(function(u,c){var h="",d=121,g=window.location.hash+"&file="+c,p="map"===sSearchMode?"small":"medium",f="map"===sSearchMode?"map-thumbnail":"justify-thumbnail";if(h+='<a class="thumb_result_link" onmousedown="preloadThumb('+c+')" onclick="thumbClick('+c+'); return false;" href="'+g+'">',sConfidenceClass="",u.confidence<40&&(sConfidenceClass="less-confident"),u.confidence<20&&(sConfidenceClass="least-confident"),h+='<div class="tree_image_container '+f+'">',h+='<img data-original="'+urlFromHash(p,u.ha,"")+'" id="'+u.i+'" class="lazy result-thumb '+sConfidenceClass+'" />',h+="</div>",h+="</a>","map"!==sSearchMode){if(t+=h,a+=parseInt(u.w)+l,n+=l,a>o||c==oResults.length-1){var m=(o-n)/(a-n),b=i;a>o&&(b=m*i),"map"===sSearchMode&&(b=d),t='<div class="justify-row" style="height:'+b+'px;">'+t+"</div>",e+=t,t="",i=r,a=0,s=0,n=0}}else e+=h;if("map"==sSearchMode){if(iMapIconModulus=4,iMapPinModulus=2,oResults.length<iStaggerMapIconLimit&&(iMapIconModulus=1,iMapPinModulus=1e4),c%iMapIconModulus==0){var v=urlFromHash("icon",u.ha,""),y=new google.maps.LatLng(u.la,u.lo),w=new google.maps.Marker({position:y,map:gmapMap,icon:v});google.maps.event.addListener(w,"click",function(){thumbClick(c)}),oaMarkers.push(w),bounds.extend(y)}else if(c%iMapPinModulus==0){var y=new google.maps.LatLng(u.la,u.lo),S=new google.maps.Marker({position:y,map:gmapMap,icon:{path:google.maps.SymbolPath.CIRCLE,scale:2,fillOpacity:1,strokeColor:sMediaDumpColor,fillColor:sMediaDumpColor}});oaMarkers.push(S),bounds.extend(y),google.maps.event.addListener(S,"click",function(){thumbClick(c)})}bMapEventsOn||gmapMap.fitBounds(bounds)}}):e='<div id="no-results" class="centred-message">no results..</div>',$("#thumb_results").html(e),$("#thumb_results img.lazy").lazyload({container:$("#results"),effect:"fadeIn",placeholder:"data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACwAAAAAAQABAAACAkQBADs=",threshold:300})}function renderPagination(){$("#map_pagination").html(""),$("#grid_pagination").html("");var e="";if("undefined"!=typeof oResults&&oResults.length>0){var t="<span>showing "+oResultsData.lower+" - "+oResultsData.upper+" / "+commafy(oResultsData.count)+"</span>";t+='<span title="elastic speed: '+parseInt(oResultsData.speed)+' ms"><i class="glyphicon glyphicon-flash"></i> found in ~'+parseInt(iSearchSpeed)+" ms</span>","browse"==sSearchMode&&(iPage>1&&(e+='<a class="btn active pull-left btn-xs" href="javascript:setPage('+(iPage-1)+');"><i class="glyphicon glyphicon-chevron-left"></i> previous</a>'),iPage<oResultsData.available_pages&&(e+='<a class="pull-right btn active btn-xs" ng-show="page < (result_info.available_pages)" href="javascript:setPage('+(iPage+1)+');">next <i class="glyphicon glyphicon-chevron-right"></i></a>')),e+=t}"map"==sSearchMode?$("#map_pagination").html(e):$("#grid_pagination").html(e)}function preloadThumb(e){if(e>-1&&e<oResults.length){var t=new Image;t.src=urlFromHash("lightbox",oResults[e].ha,"")}}function preloadNeighbours(){var e=[iFile-1,iFile+1,iFile+2];e.forEach(function(e){preloadThumb(e)})}function addQuery(e,t,o){o="undefined"!=typeof o?o:!0;var a={};a.display=e,a.value=t,oaQueries.push(a),performSearch(),o&&silentRefreshSearchInputTagUIFromQueries(),queryChange()}function silentRefreshSearchInputTagUIFromQueries(){bQueryInputEventsOn=!1;oUITags.getTags();oaQueries.forEach(function(e){oUITags.hasTag(e.display)||oUITags.addTag(String(e.display))}),bQueryInputEventsOn=!0}function addQueryFromMap(){var e=gmapMap.getBounds(),t=e.getNorthEast(),o=e.getSouthWest(),a=2,i=o.lat().toFixed(a),s=t.lat().toFixed(a),n=o.lng().toFixed(a),r=t.lng().toFixed(a),l="map=";l+=i,l+=",",l+=s,l+=",",l+=n,l+=",",l+=r,setSolitaryQuery("map search",l)}function removeQueryFromModelAndUI(e){for(var t=oaQueries.length-1;t>-1;t--)oaQueries[t].display==e&&oaQueries.splice(t,1);performSearch(),queryChange()}function emptyQueries(){removeAllQueriesFromModelAndUI(),queryChange()}function pushVarsIntoURL(){}function setAutoComplete(e){htmlAutoComplete!=e&&(htmlAutoComplete=e,updateAutoComplete())}function updateAutoComplete(){$("#autocomplete").html(htmlAutoComplete)}function setLoading(e){$("#thumb_results").html(""),bLoading!=e&&(bLoading=e,updateLoading())}function updateLoading(){bLoading?$("#loading").show():$("#loading").hide()}function setSearchMode(e){sSearchMode!=e&&(sSearchMode=e,updateSearchMode(),evaluateBrowseOrResults())}function updateSearchMode(){switch($("#browse_tree").hide(),$("#thumb_results").hide(),$("search_map").html(""),$("thumb_results").html(""),sSearchMode){case"map":$(".left_position").width("45%"),$("#thumb_results").show();break;default:$(".left_position").width("0%"),$("#browse_tree").show()}}function setPage(e){iPage!=e&&(iPage=e,updatePage(),_buildUrlFromParams())}function updatePage(){performSearch()}function setLightShowing(e){bLightboxShowing!=e&&(bLightboxShowing=e,updateLightShowing())}function updateLightShowing(){bLightboxShowing?$("#lightbox").show():$("#lightbox").hide()}function setFile(e){iFile=e,updateFile(),_buildUrlFromParams()}function updateFile(){iFile>-1?($("#lightbox_contents img").attr("src",urlFromHash("lightbox",oResults[iFile].ha,"")),preloadNeighbours()):$("#lightbox_contents img").attr("src",""),bInfoShowing&&updateFileInfo()}function evaluateBrowseOrResults(){sizeDivide(),"browse"==sSearchMode?($("#thumb_results").hide(),$("#browse_tree").hide(),oaQueries.length>0?$("#thumb_results").show():$("#browse_tree").show()):($("#thumb_results").show(),google.maps.event.trigger(gmapMap,"resize"))}function queryChange(){oaQueries.length>0?($("#browse_tree").hide(),$("#thumb_results").show()):resetDataAndUI(),_buildUrlFromParams()}function silentAddTag(e){oUITags.addTag(e)}function resetDataAndUI(){iPage=1,oaQueries=[],oResults=[],renderPagination(),$("#thumb_results").hide(),sizeDivide(),$("#browse_tree").show()}function home(){setMode("browse"),emptyQueries()}function shuffle(){setMode("browse"),setSolitaryQuery("shuffle","shuffle=random"),setUIMode("shuffle")}function setMode(e){setSearchMode(e),emptyQueries(),setUIMode(e),_buildUrlFromParams()}function setUIMode(e){$("#header-navigation li a").removeClass("active"),$("#header-navigation li a."+e+"-link").addClass("active")}function thumbClick(e){setFile(e),setLightShowing(!0)}function closeLightbox(){setLightShowing(!1),setFile(-1),$("#lightbox_info_view").html("")}function lightChange(e){iNewIndex=iFile+e,$("#lightbox_info_view").html(""),0>iNewIndex&&(iNewIndex=oResults.length-1),iNewIndex>oResults.length-1&&(iNewIndex=0),setFile(iNewIndex)}function toggleInfo(){bInfoShowing=!bInfoShowing,bInfoShowing?(updateFileInfo(),$("#lightbox").addClass("with-info")):($("#lightbox_info_view").html(""),$("#lightbox").removeClass("with-info"))}function updateFileInfo(){xhrSearch&&4!=xhrSearch.readystate&&xhrSearch.abort(),iFile>-1&&(xhrFileInfo=$.get("/view/filedata",{hash:oResults[iFile].ha},function(e){$("#lightbox_info_view").html(e)}))}function resizeend(){new Date-rtime<delta?setTimeout(resizeend,delta):(timeout=!1,sizeDivide())}function sizeDivide(){var e="50%",t=$("#main").width()-16,o=125,a=4;if("map"==sSearchMode){var e=t/2,i=Math.ceil(e/(o+a));e=i*(o+a),iLeftWidth=t-e-8,$(".left_position").width(iLeftWidth),$(".right_position").css("left",iLeftWidth),initializeGoogleMap()}else $(".left_position").width("0%"),$(".right_position").css("left","0px"),oResults.length>0&&renderResults()}function setSolitaryQuery(e,t){var o={};o.display=e,o.value=t,bQueryInputEventsOn=!1,removeAllQueriesFromModelAndUI(),bQueryInputEventsOn=!0,addQuery(e,t)}function removeAllQueriesFromModelAndUI(){oaQueries=[];var e=oUITags.getTags();for(i=e.length-1;i>-1;i--)oUITags.removeTag(e[i])}function autoSuggestSelect(e,t){$("#search-input input").val(""),setAutoComplete(""),addQuery(e,t)}function addedFromInput(e){addQuery(e,e,!1)}function sLinkSafeJSString(e){return e=e.replace(/\\/g,"\\\\")}function log(e){console.log(e)}function initializeGoogleMap(){var e=document.getElementById("map-canvas"),t={center:new google.maps.LatLng(0,0),zoom:2,mapTypeId:google.maps.MapTypeId.ROADMAP,backgroundColor:"#fff"};gmapMap=new google.maps.Map(e,t),google.maps.event.addListener(gmapMap,"idle",function(){"map"==sSearchMode&&bMapEventsOn&&addQueryFromMap(),bMapEventsOn||(bMapEventsOn=!0)})}function commafy(e){for(var t=(""+(0>e?-e:e)).split("."),o=t[0],a=L=o.length,i="";a--;)i=(0==a?"":(L-a)%3?"":",")+o.charAt(a)+i;return(0>e?"-":"")+i+(t[1]?"."+t[1]:"")}function getJSONDecodedHashUrlVars(){for(var e,t=[],o=window.location.href.slice(window.location.href.indexOf("#")+1).split("&"),a=0;a<o.length;a++)e=o[a].split("="),t.push(e[0]),t[e[0]]=decodeURIComponent(e[1]);return t}var bLoading=!1,bLightboxShowing=!1,sSearchMode="browse",bInfoShowing=!1,bMapEventsOn=!1,bFirstGeoQueryRendered=!1,gmapMap=null,rtime=new Date(1,1,2e3,12,0,0),timeout=!1,delta=200,oUITags=null,lastValue="",htmlAutoComplete="",xhrSearch,xhrSuggest,xhrFileInfo,bQueryInputEventsOn=!0,sCdnURL="http://s.mediadump.samt.st",oaQueries=[],iPage=1,iFile=-1,oTree=[],oResults=[],oResultsData=[],iSearchSpeed,oaMarkers=[],iStaggerMapIconLimit=40,bounds=new google.maps.LatLngBounds,sMediaDumpColor="#e74c3c",s_land="#c0c0c0",s_media_dump_color="#e74c3c",s_silver_colour="#bdc3c7";s_land=s_silver_colour;var media_dump_map_options={styles:[{featureType:"water",stylers:[{color:"#ffffff"}]},{featureType:"landscape.natural",stylers:[{color:s_land}]},{featureType:"poi",stylers:[{visibility:"on"},{color:s_silver_colour}]},{featureType:"road",stylers:[{color:s_media_dump_color}]},{featureType:"poi",elementType:"labels.text.stroke",stylers:[{color:"#ffffff"}]},{featureType:"poi",elementType:"labels.text.fill",stylers:[{color:"#000000"}]},{featureType:"road",elementType:"labels.text.stroke",stylers:[{color:s_silver_colour}]},{featureType:"road.local",elementType:"labels.icon",stylers:[{color:"#000000"}]},{featureType:"transit",stylers:[{color:s_silver_colour}]},{featureType:"poi",elementType:"labels.icon",stylers:[{color:"#000000"}]},{featureType:"water",elementType:"labels.text.fill",stylers:[{color:s_silver_colour}]},{elementType:"labels.text.stroke",stylers:[{color:"#ffffff"}]},{featureType:"road.highway",elementType:"labels.icon"}],backgroundColor:"#fff"};$(window).resize(function(){timeout===!1&&(timeout=!0,setTimeout(resizeend,delta))}),$(document).ready(function(){getTree(),oUITags=$("#search-input").tags({readOnly:!1,tagClass:"search-tag",promptText:"search..",afterAddingTag:function(e){bQueryInputEventsOn&&addedFromInput(e)},beforeDeletingTag:function(e){bQueryInputEventsOn&&removeQueryFromModelAndUI(e),cancelSearch()}}),$("#search-input input").on("change keyup paste",function(){$(this).val()!=lastValue&&(lastValue=$(this).val(),""==lastValue?setAutoComplete(""):(xhrSuggest&&4!=xhrSuggest.readystate&&xhrSuggest.abort(),xhrSuggest=$.get("/api/dbsuggest",{match:lastValue},function(e){var t="";e.suggestions.forEach(function(e){var o=sReplaceQuote(sLinkSafeJSString(e.value)),a=sReplaceQuote(folderFromUniqueDir(e.value)),i=(folderFromUniqueDir(o),e.value.replace(lastValue,"<strong>"+lastValue+"</strong>")),s=sGenerateLinkHref(a,o);t+="<a onclick=\"autoSuggestSelect('"+a+"', '"+o+'\');" class="auto-suggestion" href="'+s+'">',t+='<img src="'+urlFromHash("icon",e.hash,"")+'" />',t+=i,t+="</a>"}),setAutoComplete(t)})))}),$("#search-input input").focus();var e=getJSONDecodedHashUrlVars();void 0!=e.mode&&(sSearchMode=e.mode),void 0!=e.page&&(iPage=e.page);var t=void 0;void 0!=e.file&&parseInt(e.file)>-1&&(t=e.file,iFile=e.file),void 0!=e.queries&&(oaQueries=JSON.parse(decodeURIComponent(e.queries)),silentRefreshSearchInputTagUIFromQueries(),queryChange(),performSearch(t)),initializeGoogleMap(),sizeDivide(),setMode(sSearchMode)}),$(document).keydown(function(e){switch(e.which){case 37:bLightboxShowing&&lightChange(-1);break;case 39:bLightboxShowing&&lightChange(1);break;case 27:bLightboxShowing&&closeLightbox();break;case 73:bLightboxShowing&&toggleInfo();break;default:return}});